<script>
    // GROQ API - HARDCODED (temporarily to test)
    const GROQ_API_KEY = "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";
    const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
    
    // System prompt - simplified to match Poe's style
    const SYSTEM_PROMPT = `You are an AI assistant for students at UNCW, providing clear, practical guidance on safe generator use during hurricanes or emergencies.

CRITICAL RULES:
- NEVER use generators indoors, in garages, basements, or near windows/doors
- Always keep generator 20+ feet from any doors, windows, or vents
- Carbon monoxide (CO) is odorless and deadly - install CO detectors on every level
- Never refuel a hot generator - let it cool 15+ minutes first
- Never plug generator into wall outlets (no backfeeding)
- Store fuel outside in approved containers only

When someone mentions headache, dizziness, nausea, or feeling sick - respond with a CARBON MONOXIDE EMERGENCY warning telling them to LEAVE THE AREA NOW and call 911.

Always provide TWO specific safety actions they can take immediately. First action addresses the most urgent risk, second reinforces protection.

Always include relevant resource links when appropriate:
- UNCW Emergency: https://uncw.edu/emergency-safety
- National Hurricane Center: https://www.nhc.noaa.gov
- Red Cross: https://www.redcross.org/get-help/how-to-prepare-for-emergencies/types-of-emergencies/power-outage/safe-generator-use.html

End with: "Remember, generators belong OUTSIDE only, at least 20 feet from your home, with working CO detectors inside. Stay safe, Seahawks!"`;

    // Chat history
    let messages = [
        { role: "assistant", content: "üëã Hello! I'm your UNCW Generator Safety Guide. I'm here to help you stay safe during hurricanes and power outages.\n\nBefore we begin, please tell me: **Are you dealing with a power outage right now, or are you preparing before a hurricane? Is your generator currently running?**" }
    ];

    // Load messages on page load
    window.onload = function() {
        displayMessages();
    };

    function displayMessages() {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        
        messages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.role === 'user' ? 'user-message' : 'assistant-message'}`;
            
            // Convert URLs to links
            let content = msg.content.replace(/https?:\/\/[^\s]+/g, function(url) {
                return `<a href="${url}" target="_blank" style="color: #4CAF50;">${url}</a>`;
            });
            
            messageDiv.innerHTML = content.replace(/\n/g, '<br>');
            messagesDiv.appendChild(messageDiv);
        });
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addMessage(role, content) {
        messages.push({ role, content });
        displayMessages();
    }

    function checkForEmergency(input) {
        const lower = input.toLowerCase();
        if (lower.includes('headache') || lower.includes('dizzy') || lower.includes('nausea') || lower.includes('sick')) {
            return "**üö® CARBON MONOXIDE EMERGENCY üö®**\n\n1. **LEAVE THE AREA NOW** - Get to fresh air immediately\n2. **CALL 911** - This is a medical emergency\n3. **DO NOT GO BACK INSIDE**\n\nCarbon monoxide is odorless and colorless. These symptoms mean you need fresh air NOW.";
        }
        if (lower.includes('inside') || lower.includes('garage') || lower.includes('basement') || lower.includes('room') || lower.includes('indoors')) {
            return "**‚ö†Ô∏è IMMEDIATE DANGER ‚ö†Ô∏è**\n\n**STOP USING THE GENERATOR INDOORS. THIS CAN KILL YOU IN MINUTES.**\n\n1. **TURN IT OFF** right now\n2. **MOVE IT OUTSIDE** - at least 20 feet from any doors, windows, or vents\n3. **OPEN WINDOWS** to ventilate if anyone feels sick\n4. **CALL 911** if anyone has headache, dizziness, or nausea";
        }
        return null;
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message
        addMessage('user', message);
        input.value = '';
        
        // Check for emergency
        const emergencyResponse = checkForEmergency(message);
        if (emergencyResponse) {
            addMessage('assistant', emergencyResponse);
            return;
        }
        
        // Show thinking
        addMessage('assistant', '‚ö° Thinking...');
        
        try {
            // Call Groq API
            const response = await fetch(GROQ_API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'qwen/qwen3-32b',
                    messages: [
                        { role: 'system', content: SYSTEM_PROMPT },
                        ...messages.slice(-6) // Last 6 messages for context
                    ],
                    temperature: 0.3,
                    max_tokens: 1024
                })
            });
            
            // Remove thinking message
            messages.pop();
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const data = await response.json();
            const assistantMessage = data.choices[0].message.content;
            
            addMessage('assistant', assistantMessage);
            
        } catch (error) {
            // Remove thinking message
            messages.pop();
            
            // Show error with safety tips
            const errorMsg = "‚ö†Ô∏è Connection error. Please try again.\n\n**Remember the safety rules:**\n‚Ä¢ Generators go OUTSIDE only, 20+ feet from home\n‚Ä¢ Install CO detectors on every level\n‚Ä¢ Never refuel while hot\n‚Ä¢ Call 911 for emergencies";
            addMessage('assistant', errorMsg);
            console.error('Error:', error);
        }
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function clearConversation() {
        messages = [
            { role: "assistant", content: "üëã Hello! I'm your UNCW Generator Safety Guide. I'm here to help you stay safe during hurricanes and power outages.\n\nBefore we begin, please tell me: **Are you dealing with a power outage right now, or are you preparing before a hurricane? Is your generator currently running?**" }
        ];
        displayMessages();
    }
</script>
